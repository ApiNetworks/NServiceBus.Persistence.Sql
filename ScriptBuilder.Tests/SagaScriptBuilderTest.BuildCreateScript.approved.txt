
declare @schema char = '{1}';
declare @endpointName char = '{2}';
declare @sagaName char = '{3}';
declare @tableName char = '[' + @schema + '].[' + @endpointName + '.' + @sagaName + ']';


IF NOT EXISTS 
(
    SELECT * 
    FROM sys.objects 
    WHERE 
        object_id = OBJECT_ID(@tableName) AND 
        type in (N'U')
)
BEGIN
DECLARE @DynamicSQL nvarchar(1000);
SET @DynamicSQL = N'
    CREATE TABLE [theschema].[theendpointname.theSaga](
	    [Id] [uniqueidentifier] NOT NULL PRIMARY KEY,
	    [Originator] [nvarchar](255) NULL,
	    [OriginalMessageId] [nvarchar](255) NULL,
	    [Data] [xml] NOT NULL,
	    [PersistenceVersion] [nvarchar](23) NOT NULL,
	    [SagaTypeVersion] [nvarchar](23) NOT NULL
    )
';
exec(@DynamicSQL);
END

declare @dropIndexQuery nvarchar(max);
select @dropIndexQuery = 
(
    SELECT 'DROP INDEX ' + ix.name + ' ON ' + @tableName + '; '
    FROM sysindexes ix
    WHERE 
	    ix.Name IS NOT null AND 
	    ix.Name LIKE 'PropertyIndex_%' AND
	    ix.Name NOT IN ('Property1', 'Property2')
    for xml path('')
);
exec sp_executesql @dropIndexQuery

IF NOT EXISTS
(
    SELECT * 
    FROM sys.indexes 
    WHERE 
        name = 'PropertyIndex_Property1' AND 
        object_id = OBJECT_ID('[theschema].[theendpointname.theSaga]')
)
BEGIN
    CREATE  SELECTIVE XML INDEX PropertyIndex_Property1
    ON [theschema].[theendpointname.theSaga](Data)
    FOR 
    (
        Property1 = '/Data/Property1' AS XQUERY 'xs:string' SINGLETON
    )
END

IF NOT EXISTS
(
    SELECT * 
    FROM sys.indexes 
    WHERE 
        name = 'PropertyIndex_Property2' AND 
        object_id = OBJECT_ID('[theschema].[theendpointname.theSaga]')
)
BEGIN
    CREATE  SELECTIVE XML INDEX PropertyIndex_Property2
    ON [theschema].[theendpointname.theSaga](Data)
    FOR 
    (
        Property2 = '/Data/Property2' AS XQUERY 'xs:string' SINGLETON
    )
END
