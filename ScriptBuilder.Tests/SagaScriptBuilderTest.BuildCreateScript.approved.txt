
declare @tableName nvarchar(max) = '[' + @schema + '].[' + @endpointName + '.theSaga]';


IF NOT EXISTS
(
    SELECT *
    FROM sys.objects
    WHERE
        object_id = OBJECT_ID(@tableName) AND
        type in (N'U')
)
BEGIN
DECLARE @createTable nvarchar(max);
SET @createTable = N'
    CREATE TABLE ' + @tableName + N'(
	    [Id] [uniqueidentifier] NOT NULL PRIMARY KEY,
	    [Originator] [nvarchar](255) NULL,
	    [OriginalMessageId] [nvarchar](255) NULL,
	    [Data] [xml] NOT NULL,
	    [PersistenceVersion] [nvarchar](23) NOT NULL,
	    [SagaTypeVersion] [nvarchar](23) NOT NULL
    )
';
exec(@createTable);
END

declare @dropIndexQuery nvarchar(max);
select @dropIndexQuery =
(
    SELECT 'DROP INDEX ' + ix.name + ' ON ' + @tableName + '; '
    FROM sysindexes ix
    WHERE
		ix.Id = (select object_id from sys.objects where name = @tableName) AND
	    ix.Name IS NOT null AND
	    ix.Name LIKE 'PropertyIndex_%' AND
	    ix.Name <> 'PropertyIndex_Property1'
    for xml path('')
);
exec sp_executesql @dropIndexQuery

IF NOT EXISTS
(
    SELECT *
    FROM sys.indexes
    WHERE
        name = 'PropertyIndex_Property1' AND
        object_id = OBJECT_ID(@tableName)
)
BEGIN
DECLARE @createIndex nvarchar(max);
SET @createIndex = N'
    CREATE  SELECTIVE XML INDEX PropertyIndex_Property1
    ON ' + @tableName + '(Data)
    FOR
    (
        Property1 = ''/Data/Property1'' AS XQUERY ''xs:string'' SINGLETON
    )
';
exec(@createIndex);
END
