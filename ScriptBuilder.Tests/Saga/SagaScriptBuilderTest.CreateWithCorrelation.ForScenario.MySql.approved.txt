
/* TableNameVariable */ 

set @tableName = concat(@tablePrefix, 'theSaga');
set @fullTableName = concat(@schema, '.', @tableName);


/* CreateTable */ 

set @createTable = concat('
    create table if not exists ', @tableName, '(
        Id varchar(38) not null,
        Originator varchar(255),
        OriginalMessageId varchar(255),
        Data longtext not null,
        PersistenceVersion varchar(23) not null,
        SagaTypeVersion varchar(23) not null,
        primary key (`Id`)
    ) DEFAULT CHARSET=utf8;
');
prepare statment from @createTable;
execute statment;
deallocate prepare statment;

/* AddProperty CorrelationProperty */ 

select count(*)
into @exist
from information_schema.columns 
where table_schema = database()
      and column_name = 'Correlation_CorrelationProperty'
      and table_name = @tableName;

set @query = IF(
    @exist <= 0, 
    concat('alter table ', @tableName, ' add column Correlation_CorrelationProperty varchar(450)'), 
    'select \'Column Exists\' status');

prepare statment from @query;
execute statment;
deallocate prepare statment;

/* VerifyColumnType String */ 

set @column_type_CorrelationProperty = (
  select column_type
  from information_schema.columns
  where
    table_schema = database() and 
    table_name = @tableName and
    column_name = 'Correlation_CorrelationProperty'
);

set @query = IF(
    @column_type_CorrelationProperty <> 'varchar(450)', 
    'SIGNAL SQLSTATE \'45000\' SET MESSAGE_TEXT = \'Incorrect data type for Correlation_CorrelationProperty\'', 
    'select \'Column Type OK\' status');

prepare statment from @query;
execute statment;
deallocate prepare statment;

/* WriteCreateIndex CorrelationProperty */ 

select count(*)
into @exist
from information_schema.statistics 
where 
    table_schema = database() and 
    index_name = 'Index_Correlation_CorrelationProperty' and 
    table_name = @tableName;

set @query = IF(
    @exist <= 0, 
    concat('create unique index Index_Correlation_CorrelationProperty on ', @tableName, '(Correlation_CorrelationProperty)'), 
    'select \'Index Exists\' status');

prepare statment from @query;
execute statment;
deallocate prepare statment;

/* PurgeObsoleteIndex */ 

select @dropIndexQuery =
(
    select concat('drop index ', index_name, ' on ', @tableName, ';')
    from information_schema.statistics
    where
        table_name = @tableName and
        index_name like 'Index_Correlation_%' and
        index_name <> 'Index_Correlation_CorrelationProperty' and
        table_schema = database()
);
select if (
    @dropIndexQuery is not null,
    @dropIndexQuery,
    'select ''no index to delete'';')
    into @dropIndexQuery;

prepare statment from @dropIndexQuery;
execute statment;
deallocate prepare statment;

/* PurgeObsoleteProperties */ 

select @dropPropertiesQuery =
(
    select concat('alter table ', @tableName, ' drop column ', col.column_name, ';')
    from information_schema.columns col
    where
        col.table_name = @tableName and
        col.column_name like 'Correlation_%' and
        col.column_name <> 'Correlation_CorrelationProperty'
);

select if (
    @dropPropertiesQuery is not null,
    @dropPropertiesQuery,
    'select ''no property to delete'';')
    into @dropPropertiesQuery;

prepare statment from @dropPropertiesQuery;
execute statment;
deallocate prepare statment;
